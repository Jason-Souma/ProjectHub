import React, { useState, useEffect, useCallback } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar } from 'recharts';
import * as SliderPrimitive from '@radix-ui/react-slider'; // Using Radix UI for Slider
import * as InputPrimitive from '@radix-ui/react-input'; // Using Radix UI for Input

// Helper function to format currency
const formatCurrency = (value) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'ZAR',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(value);
};

// Helper function to format percentage (not used directly in display but good for consistency)
const formatPercentage = (value) => {
  return new Intl.NumberFormat('en-US', {
    style: 'percent',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(value / 100);
};

// Custom Slider component using Radix UI primitives and Tailwind CSS
const Slider = React.forwardRef(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={`relative flex w-full touch-none select-none items-center ${className}`}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-1.5 w-full grow overflow-hidden rounded-full bg-gray-600">
      <SliderPrimitive.Range className="absolute h-full bg-purple-500" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-4 w-4 rounded-full border border-purple-500 bg-purple-500 shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-purple-500 disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
));
Slider.displayName = SliderPrimitive.Root.displayName;


// Main App Component
const App = () => {
  // Input states
  const [principal, setPrincipal] = useState(200000); // Initial loan amount
  const [loanTermYears, setLoanTermYears] = useState(30); // Loan term in years
  const [interestRate, setInterestRate] = useState(4.5); // Annual interest rate percentage
  const [paymentFrequency, setPaymentFrequency] = useState('monthly'); // 'monthly' or 'bi-weekly'
  const [extraPayment, setExtraPayment] = useState(0); // Extra monthly repayment

  // Calculated states
  const [monthlyPayment, setMonthlyPayment] = useState(0); // Estimated payment per period
  const [totalInterestPaid, setTotalInterestPaid] = useState(0); // Total interest paid over loan life
  const [totalTimeMonths, setTotalTimeMonths] = useState(0); // Total number of payments (periods)
  const [amortizationSchedule, setAmortizationSchedule] = useState([]); // Detailed payment schedule
  const [chartData, setChartData] = useState([]); // Data for the payment breakdown chart

  // Function to calculate loan details and amortization schedule
  const calculateLoan = useCallback(() => {
    let P = parseFloat(principal); // Principal amount
    let annualRate = parseFloat(interestRate) / 100; // Annual interest rate as decimal
    let N = parseFloat(loanTermYears); // Loan term in years
    let extra = parseFloat(extraPayment); // Extra payment per period

    // Validate inputs
    if (isNaN(P) || isNaN(annualRate) || isNaN(N) || P <= 0 || annualRate < 0 || N <= 0) {
      // Reset all calculated states if inputs are invalid
      setMonthlyPayment(0);
      setTotalInterestPaid(0);
      setTotalTimeMonths(0);
      setAmortizationSchedule([]);
      setChartData([]);
      return;
    }

    let periodicRate; // Interest rate per payment period
    let totalPeriods; // Total number of payment periods
    let paymentsPerYear; // Number of payments in a year

    // Determine periodic rate and total periods based on payment frequency
    switch (paymentFrequency) {
      case 'monthly':
        periodicRate = annualRate / 12;
        totalPeriods = N * 12;
        paymentsPerYear = 12;
        break;
      case 'bi-weekly':
        periodicRate = annualRate / 26; // Assuming 26 bi-weekly periods in a year
        totalPeriods = N * 26;
        paymentsPerYear = 26;
        break;
      default:
        // Default to monthly if frequency is unrecognized
        periodicRate = annualRate / 12;
        totalPeriods = N * 12;
        paymentsPerYear = 12;
    }

    let calculatedPeriodicPayment = 0;
    if (periodicRate === 0) {
      // Handle zero interest rate: simple division of principal by total periods
      calculatedPeriodicPayment = P / totalPeriods;
    } else {
      // Standard loan payment formula (M = P [ i(1 + i)^n ] / [ (1 + i)^n â€“ 1])
      calculatedPeriodicPayment = P * (periodicRate * Math.pow(1 + periodicRate, totalPeriods)) / (Math.pow(1 + periodicRate, totalPeriods) - 1);
    }

    // Set the estimated payment for display
    setMonthlyPayment(calculatedPeriodicPayment);

    let balance = P; // Current remaining loan balance
    let totalInterest = 0; // Accumulator for total interest paid
    let schedule = []; // Array to store amortization schedule entries
    let currentPaymentNumber = 0; // Counter for payment periods
    let chartDataPoints = []; // Data for the chart visualization

    // Maximum iterations to prevent infinite loops in extreme scenarios (e.g., very small payments)
    const maxIterations = totalPeriods * 2; // Allow up to double the original term

    // Loop through payments until balance is paid off or max iterations reached
    while (balance > 0.01 && currentPaymentNumber < maxIterations) {
      currentPaymentNumber++; // Increment payment period
      const interestThisPeriod = balance * periodicRate; // Interest for the current period
      
      // Calculate effective payment including extra payment
      let effectivePayment = calculatedPeriodicPayment + extra;
      let effectivePrincipalPayment = effectivePayment - interestThisPeriod;

      // Adjust for the last payment: ensure we don't overpay
      if (balance + interestThisPeriod <= effectivePayment) {
        effectivePrincipalPayment = balance; // Pay off remaining principal
        effectivePayment = balance + interestThisPeriod; // Total payment for the final period
      }

      // Ensure principal payment is not negative
      if (effectivePrincipalPayment < 0) {
        effectivePrincipalPayment = 0;
      }

      balance -= effectivePrincipalPayment; // Deduct principal paid from balance
      totalInterest += interestThisPeriod; // Add interest to total interest paid

      // Correct balance for floating point inaccuracies, ensuring it doesn't go negative
      if (balance < 0) {
        effectivePrincipalPayment += balance; // Adjust principal paid to make balance exactly 0
        balance = 0;
      }

      // Add current period's data to the amortization schedule
      schedule.push({
        period: currentPaymentNumber,
        payment: effectivePayment,
        principalPaid: effectivePrincipalPayment,
        interestPaid: interestThisPeriod,
        remainingBalance: balance,
      });

      // Add data for chart visualization. If bi-weekly, aggregate to monthly for cleaner chart.
      if (paymentFrequency === 'monthly' || currentPaymentNumber % (paymentsPerYear / 12) === 0) {
        chartDataPoints.push({
          period: Math.ceil(currentPaymentNumber / (paymentsPerYear / 12)), // Use a monthly equivalent for chart X-axis
          principal: effectivePrincipalPayment,
          interest: interestThisPeriod,
        });
      }
    }

    // Update state with calculated results
    setTotalInterestPaid(totalInterest);
    setTotalTimeMonths(currentPaymentNumber); // Total number of periods taken to repay
    setAmortizationSchedule(schedule);
    setChartData(chartDataPoints);

  }, [principal, loanTermYears, interestRate, paymentFrequency, extraPayment]); // Dependencies for useCallback

  // Effect hook to recalculate loan details whenever any input changes
  useEffect(() => {
    calculateLoan();
  }, [calculateLoan]); // Dependency on calculateLoan to re-run when its dependencies change

  // Event handlers for input changes
  const handlePrincipalChange = (e) => setPrincipal(parseFloat(e.target.value || 0));
  const handleLoanTermYearsChange = (e) => setLoanTermYears(parseFloat(e.target.value || 0));
  const handleInterestRateChange = (e) => setInterestRate(parseFloat(e.target.value || 0));
  const handlePaymentFrequencyChange = (e) => setPaymentFrequency(e.target.value);
  const handleExtraPaymentChange = (e) => setExtraPayment(parseFloat(e.target.value || 0));
  const handleExtraPaymentSliderChange = (value) => setExtraPayment(value[0]); // Slider returns an array

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-gray-100 font-inter p-4 sm:p-8 rounded-lg shadow-lg">
      <h1 className="text-4xl font-bold text-center mb-8 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
        Home Loan Simulator
      </h1>

      <div className="max-w-6xl mx-auto bg-gray-800 bg-opacity-70 rounded-xl p-6 sm:p-8 shadow-2xl border border-gray-700">
        {/* Input Section */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
          {/* Principal Amount Input */}
          <div className="flex flex-col">
            <label htmlFor="principal" className="text-gray-300 text-sm font-medium mb-2">
              Principal Amount
            </label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
              <input
                id="principal"
                type="number"
                value={principal}
                onChange={handlePrincipalChange}
                className="w-full p-3 pl-8 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-gray-100 placeholder-gray-400"
                placeholder="e.g., 200000"
              />
            </div>
          </div>

          {/* Loan Term Input */}
          <div className="flex flex-col">
            <label htmlFor="loanTermYears" className="text-gray-300 text-sm font-medium mb-2">
              Loan Term (Years)
            </label>
            <input
              id="loanTermYears"
              type="number"
              value={loanTermYears}
              onChange={handleLoanTermYearsChange}
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-gray-100 placeholder-gray-400"
              placeholder="e.g., 30"
            />
          </div>

          {/* Interest Rate Input */}
          <div className="flex flex-col">
            <label htmlFor="interestRate" className="text-gray-300 text-sm font-medium mb-2">
              Interest Rate (Annual %)
            </label>
            <div className="relative">
              <input
                id="interestRate"
                type="number"
                step="0.01"
                value={interestRate}
                onChange={handleInterestRateChange}
                className="w-full p-3 pr-8 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-gray-100 placeholder-gray-400"
                placeholder="e.g., 4.5"
              />
              <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">%</span>
            </div>
          </div>

          {/* Payment Frequency Select */}
          <div className="flex flex-col">
            <label htmlFor="paymentFrequency" className="text-gray-300 text-sm font-medium mb-2">
              Payment Frequency
            </label>
            <select
              id="paymentFrequency"
              value={paymentFrequency}
              onChange={handlePaymentFrequencyChange}
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-gray-100"
            >
              <option value="monthly">Monthly</option>
              <option value="bi-weekly">Bi-Weekly</option>
            </select>
          </div>

          {/* Extra Monthly Repayment Input and Slider */}
          <div className="flex flex-col col-span-1 md:col-span-2">
            <label htmlFor="extraPayment" className="text-gray-300 text-sm font-medium mb-2">
              Extra Monthly Repayment
            </label>
            <div className="flex items-center gap-4">
              <div className="relative flex-grow">
                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                <input
                  id="extraPayment"
                  type="number"
                  value={extraPayment}
                  onChange={handleExtraPaymentChange}
                  className="w-full p-3 pl-8 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-gray-100 placeholder-gray-400"
                  placeholder="e.g., 100"
                />
              </div>
              <Slider
                className="w-full flex-grow-2" // Tailwind classes for width and flex grow
                min={0}
                max={5000} // Max extra payment, adjust as needed
                step={10}
                value={[extraPayment]} // Slider expects an array for value
                onValueChange={handleExtraPaymentSliderChange}
              />
            </div>
          </div>
        </div>

        {/* Results Section */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 text-center">
          {/* Estimated Payment Card */}
          <div className="bg-gray-700 p-6 rounded-xl shadow-md border border-gray-600">
            <h3 className="text-lg font-semibold text-gray-300 mb-2">Estimated Payment ({paymentFrequency === 'monthly' ? 'Monthly' : 'Per Period'})</h3>
            <p className="text-3xl font-bold text-green-400">{formatCurrency(monthlyPayment)}</p>
          </div>
          {/* Total Interest Paid Card */}
          <div className="bg-gray-700 p-6 rounded-xl shadow-md border border-gray-600">
            <h3 className="text-lg font-semibold text-gray-300 mb-2">Total Interest Paid</h3>
            <p className="text-3xl font-bold text-red-400">{formatCurrency(totalInterestPaid)}</p>
          </div>
          {/* Total Time to Repay Card */}
          <div className="bg-gray-700 p-6 rounded-xl shadow-md border border-gray-600">
            <h3 className="text-lg font-semibold text-gray-300 mb-2">Total Time to Repay</h3>
            <p className="text-3xl font-bold text-blue-400">
              {/* Convert total periods to years and months for display */}
              {Math.floor(totalTimeMonths / (paymentFrequency === 'monthly' ? 12 : 26))} Years{' '}
              {Math.round((totalTimeMonths % (paymentFrequency === 'monthly' ? 12 : 26)) / (paymentFrequency === 'monthly' ? 1 : 2.16))} Months
            </p>
          </div>
        </div>

        {/* Loan Repayment Visualization (Bar Chart) */}
        <div className="mb-10 bg-gray-700 p-6 rounded-xl shadow-md border border-gray-600">
          <h2 className="text-2xl font-bold text-gray-100 mb-4 text-center">Payment Breakdown Over Time</h2>
          <ResponsiveContainer width="100%" height={400}>
            <BarChart
              data={chartData}
              margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
            >
              <CartesianGrid strokeDasharray="3 3" stroke="#4a4a4a" /> {/* Grid lines */}
              <XAxis dataKey="period" stroke="#bbb" /> {/* X-axis for periods */}
              <YAxis stroke="#bbb" tickFormatter={(value) => formatCurrency(value)} /> {/* Y-axis for currency */}
              <Tooltip
                // Custom formatter for tooltip content
                formatter={(value, name) => [`${formatCurrency(value)}`, name === 'principal' ? 'Principal' : 'Interest']}
                labelFormatter={(label) => `Period: ${label}`} // Label for tooltip
                contentStyle={{ backgroundColor: '#333', border: 'none', borderRadius: '8px' }} // Tooltip styling
                labelStyle={{ color: '#eee' }}
              />
              <Legend wrapperStyle={{ color: '#eee' }} /> {/* Legend styling */}
              <Bar dataKey="principal" stackId="a" fill="#8884d8" name="Principal Paid" radius={[4, 4, 0, 0]} /> {/* Principal bar */}
              <Bar dataKey="interest" stackId="a" fill="#82ca9d" name="Interest Paid" radius={[4, 4, 0, 0]} /> {/* Interest bar */}
            </BarChart>
          </ResponsiveContainer>
        </div>

        {/* Amortization Schedule Table */}
        <div className="bg-gray-700 p-6 rounded-xl shadow-md border border-gray-600 overflow-x-auto">
          <h2 className="text-2xl font-bold text-gray-100 mb-4 text-center">Amortization Schedule</h2>
          <div className="max-h-[500px] overflow-y-auto custom-scrollbar"> {/* Scrollable container for table */}
            <table className="w-full text-left table-auto">
              <thead className="sticky top-0 bg-gray-800 text-gray-300 uppercase text-sm leading-normal">
                <tr>
                  <th className="py-3 px-6 text-left rounded-tl-lg">Period</th>
                  <th className="py-3 px-6 text-left">Payment</th>
                  <th className="py-3 px-6 text-left">Principal Paid</th>
                  <th className="py-3 px-6 text-left">Interest Paid</th>
                  <th className="py-3 px-6 text-left rounded-tr-lg">Remaining Balance</th>
                </tr>
              </thead>
              <tbody className="text-gray-200 text-sm font-light">
                {amortizationSchedule.map((item, index) => (
                  <tr key={index} className="border-b border-gray-600 hover:bg-gray-600 transition-colors duration-200">
                    <td className="py-3 px-6 whitespace-nowrap">{item.period}</td>
                    <td className="py-3 px-6">{formatCurrency(item.payment)}</td>
                    <td className="py-3 px-6">{formatCurrency(item.principalPaid)}</td>
                    <td className="py-3 px-6">{formatCurrency(item.interestPaid)}</td>
                    <td className="py-3 px-6">{formatCurrency(item.remainingBalance)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
